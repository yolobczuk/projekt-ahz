---
title: "R Notebook"
output: html_notebook
---



```{r include = F}
library(survival)
library(survMisc)
library(gtools)
library(ggplot2)
library(dplyr)
library(tidyr)
```

## Wprowadzenie, eksploracyjna analiza danych



Badany w niniejszym opracowaniu zbiór danych składa się z danych leczniczysz odnoszących się do wyników koagulacji laswerowej w leczeniu ratinopatii cukrzycowej. Samo schorzenie spowodowane jest uszkodzeniem naczyń krwionośnych siatkówki oka. W celu wyleczenia schorzenia używana jest laseroteriapa siatkówki. W niniejszej pracy analizowana przez nas będzie czas przeżycia w kontekście utraty ostrości wzrosku oraz wpływu danych zmiennych na przedłużanie tego procesu. W pliku zajdziemy następujące inforamcje:
  - **id**: Odnosi się do indywidualnego numeru badanej jednostki. W grupie badawczej jest 197 indywidualnych jednostek.
  - **laser**: typ zastosowanego rozwiązania laserowego w leczeniu. W próbie znajdują się dwie zmienne. Xenon oraz argon.
  - **age**: Wiek pacjenta w chwili wykrycia schorzenia.
  - **eye**: Badane oko. Zmienne to "left" oraz "right"
  - **trt**: Zmienna dychtomiczna odnosząca się do leczenia. 0 = brak leczenia, 1 =  leczenie laserowe.
  - **risk**: Grupy ryzyka w skali 6-12.
  - **time**: Czas w miesiącach do wystąpienia zdarzenia utraty wzroku, bądź ostatnia zaobserwowana obserwacja.
  - **status**: Status badanego w postaci dychotomicznej. 0 = ocenzurowane, 1 = utrata wzrosku przez badaną jednostkę.


```{r}
diabetic <- survival::diabetic

summary(diabetic)
```

Powyżej widoczne jest wstępne podsumowanie zmiennych zawartych w rozpatrywanym przez nas zbiorze danych. Widać, że w zbiorze danych nie występują wartości NA oznaczające brak danych. R zinterpretował zmienne `trt` oraz `risk` jako zmienne numeryczne, gdy one tak naprawdę są zmiennymi typu factor. Poniższy kod zamienia typy tych zmiennych na prawidłowe.

```{r}

diabetic <- diabetic %>% mutate(trt = as.factor(as.character(trt)), risk = as.factor(risk))

```

Spojrzymy również na rozkłady tych zmiennych, już po kategoryzacji.

```{r}

diabetic.plot.hist = diabetic %>% dplyr::select(c(age, time))

plot1 <- ggplot(gather(diabetic.plot.hist), aes(x = value)) +  
  geom_histogram(colour = 1, fill = "blue", bins = 30)+
  ggtitle("Rozkłady zmiennych zbioru danych")+
  ylab("Częstość występowania")+
  xlab("Wartość zmiennej")+
  facet_wrap(~ key, scales = "free", ncol = 2)
plot1

diabetic.plot.bar = diabetic %>% dplyr::select(c(laser, eye, trt, status))

plot2 <- ggplot(gather(diabetic.plot.bar), aes(x = value)) +  
  geom_bar(colour = 1, fill = "blue")+
  ggtitle("Rozkłady zmiennych zbioru danych")+
  ylab("Częstość występowania")+
  xlab("Wartość zmiennej")+
  facet_wrap(~ key, scales = "free", ncol = 2)
plot2

ggplot(as.data.frame(table(diabetic$risk)), aes(x=Var1, y = Freq)) + geom_col(colour = 1, fill = "blue")+
    ylab("Częstość występowania")+
    xlab("Wartość zmiennej risk")

rm(diabetic.plot.bar)
rm(diabetic.plot.hist)
```

Na powyższych wykresach dokonaliśmy wizualizacji badanych zmiennych. W przypadku pierwszego z nich zauważyć może częstotliwość występowowania zmiennej **age** oraz **time**. Zauważyć możemy, iż duża ilość pacjentów diagnozowana jest w stosunkowo młodym wieku, gdyż pomiędzy około 9 a 20 rokiem życia. Najmniej diagnozuje się to w wieku powyżej 55 roku życia badanej jednostki. Jednocześnie obok widoczny jest wykres częstotliowści czasu do utraty wzroku. Najczęściej występują zmienne time w okolicy pierwszych 10 miesięcy oraz od 40 do 50 miesięcy.
Kolejne wykresy przedstawiają rozkłąd dla zmiennych **eye**, **laser**, **status** oraz **trt**. W przypadku zmiennej eye mamy równą ilość badanych zmiennych. Ale możemy zwrócić na znaczną przewagę użycia xenonu, zamiast argonu w zmiennych laser. Dodatkowo widzimy, iż w zmiennej status przeważa liczba danych cenzurowanych (239) niż utraty wzroku (155). Ostania prezentowana na wykresie zmienna to trt. W tym przypadku mamy równą liczbę zmiennych.
Ostatni analizowany powyżej wykres prezentuje rozkład częstości występowania zmiennej **risk**. Widać, że najczęściej przypisywana jest wartość 9 oraz 10. Najmniej jest niskiego ryzyka na poziomie 6 oraz 8. 

## Wstępna analiza utraty wzroku

Analizę rozpoczniemy od estymacji krzywej prawdopodobieństwa zachowania wzroku w stosunku do czasu dla estymatorów Kaplana-Meiera oraz Nelsona-Aalena. Przerywanymi liniami zaznaczony został 95\% przedział ufności tych estymatorów. 

```{r}
mod.1 <- survfit(Surv(time, status) ~ 1, conf.type="plain", data=diabetic)
mod.2 <- survfit(Surv(time, status) ~ 1, conf.type="plain", type="fleming-harrington", data=diabetic)

plot(mod.1, xlab="Czas", ylab="Prawdopodobieństwo zachowania wzroku", col = 'black', pch=16)
lines(mod.2, col="red", pch=16)
legend(x = 'bottom', legend = c('Kaplan-Meier','Nelson-Aalen'), col = c('black','red'), pch=16)
```

Na powyższym wykresie nie zauważyliśmy dużych różnic pomiędzy estymatorami. Bardzo szybko (po około 2 miesiącach) prawdopodobieństwo zachowania wzroku spada poniżej 1 i utrzymuje ten spadek aż do poziomu około 60\% na którym to utrzymuje się od 60 miesięcy aż do 75 miesięcy. Spojrzymy teraz na wykresy skumulowanego hazardu.

```{r}
plot(mod.1, fun="cumhaz", xlab="Czas", ylab="Hazard skumulowany", col = 'black')
lines(mod.2, fun="cumhaz", col="red")
legend(x = 'bottom', legend = c('Kaplan-Meier','Nelson-Aalen'), col = c('black','red'), pch=16)

rm(mod.1)
rm(mod.2)
```

Oferują nam one bardzo podobną interpretację jak wykresy prawdopodobieństw. Szansa na utratę wzroku bardzo szybko (znów po około 2 miesiącach) było większe od 0 i w dość równomierny sposób wzrastała do poziomu około 0.6, na którym to utrzymywała się od około 60 miesięcy do końca osi X czyli 75 miesięcy. Przejdziemy teraz do wyznaczenia krzywych dla predyktorów zawartych w naszym zbiorze danych - zmiennych `trt`, `age`, `laser`, `eye` oraz `risk`.

```{r}
mod.km.trt <- survfit(Surv(time, status) ~ trt, conf.type="plain", data=diabetic)
mod.na.trt <- survfit(Surv(time, status) ~ trt, conf.type="plain", data=diabetic, type="fleming-harrington")

plot(mod.km.trt, xlab="Czas", ylab="Prawdopodobieństwo zachowania wzroku", col = 'black', main="Krzywa zachowania wzroku dla zmiennej trt")
lines(mod.na.trt, col="red")
legend(x = 'bottom', legend = c('Kaplan-Meier','Nelson-Aalen'), col = c('black','red'), pch=16)

mod.km.age <- survfit(Surv(time, status) ~ age, conf.type="plain", data=diabetic)
mod.na.age <- survfit(Surv(time, status) ~ age, conf.type="plain", data=diabetic, type="fleming-harrington")

plot(mod.km.age, xlab="Czas", ylab="Prawdopodobieństwo zachowania wzroku", col = 'black', main="Krzywa zachowania wzroku dla zmiennej age")
lines(mod.na.age, col="red")
legend(x = 'bottom', legend = c('Kaplan-Meier','Nelson-Aalen'), col = c('black','red'), pch=16)

mod.km.laser <- survfit(Surv(time, status) ~ laser, conf.type="plain", data=diabetic)
mod.na.laser <- survfit(Surv(time, status) ~ laser, conf.type="plain", data=diabetic, type="fleming-harrington")

plot(mod.km.laser, xlab="Czas", ylab="Prawdopodobieństwo zachowania wzroku", col = 'black', main="Krzywa zachowania wzroku dla zmiennej laser")
lines(mod.na.laser, col="red")
legend(x = 'bottom', legend = c('Kaplan-Meier','Nelson-Aalen'), col = c('black','red'), pch=16)

mod.km.eye <- survfit(Surv(time, status) ~ eye, conf.type="plain", data=diabetic)
mod.na.eye <- survfit(Surv(time, status) ~ eye, conf.type="plain", data=diabetic, type="fleming-harrington")

plot(mod.km.eye, xlab="Czas", ylab="Prawdopodobieństwo zachowania wzroku", col = 'black', main="Krzywa zachowania wzroku dla zmiennej eye")
lines(mod.na.eye, col="red")
legend(x = 'bottom', legend = c('Kaplan-Meier','Nelson-Aalen'), col = c('black','red'), pch=16)

mod.km.risk <- survfit(Surv(time, status) ~ risk, conf.type="plain", data=diabetic)
mod.na.risk <- survfit(Surv(time, status) ~ risk, conf.type="plain", data=diabetic, type="fleming-harrington")

plot(mod.km.risk, xlab="Czas", ylab="Prawdopodobieństwo zachowania wzroku", col = 'black', main="Krzywa zachowania wzroku dla zmiennej risk")
lines(mod.na.risk, col="red")
legend(x = 'bottom', legend = c('Kaplan-Meier','Nelson-Aalen'), col = c('black','red'), pch=16)


```

**Krzywa zachowania wzroku zmiennej trt**
Powyżej przedstawione zostały wykresy prawdopodbieństwa zachowania wzroku z wykorzystaniem estymatora Kaplana-Meiera oraz Nelona-Aalena. Widzimy w przypadku krzywej zachowania wzroku dla zmiennej **trt**, że prawdopodobeństwo zachowania wzroku stopniowo maleje. W przypadku estymatora Nelsona-Aalena jednostka ma 80% na utrzymanie wzroku dłużej niż przez 11 miesięcy. Estymator Kaplana-Meiera wskazuje, że jest 80% szans na utrzymanie wzroku dłużej niż 25 miesięcy. Jest bardzo duża różnica na 60 miesiącach, gdzie estymator Nelsona-Aalena wskazuje na 40% szans utrzymania wzroku dłużej niż 60 miesięcy od diagnozy, a estymator Kaplana-Meiera wskazuje 70% szans na utrzymanie wzroku dłużej niż 60 miesięcy.


**Krzywa zachowania wzroku zmiennej age**
Ze względu na dość chaotyczny wygląd wykresu dla zmiennej age, zdecydowaliśmy się na faktoryzację tej zmiennej poprzez podział kwantylowy. Poniżej znajdują się wykresy z estymatorami K-M oraz N-A dla tej zmiennej.


```{r}
diabetic$ageCat <- quantcut(diabetic$age,q=4)

mod.km.ageCat <- survfit(Surv(time, status) ~ ageCat, conf.type="plain", data=diabetic)
mod.na.ageCat <- survfit(Surv(time, status) ~ ageCat, conf.type="plain", data=diabetic, type="fleming-harrington")

plot(mod.km.ageCat, xlab="Czas", ylab="Prawdopodobieństwo zachowania wzroku", col = 'black', main="Krzywa zachowania wzroku dla zmiennej ageCat (po faktoryzacji)")
lines(mod.na.ageCat, col="red")
legend(x = 'bottom', legend = c('Kaplan-Meier','Nelson-Aalen'), col = c('black','red'), pch=16)
```

Interpretacja...

Po wizualnej inspekcji przyszedł czas na formalne testy. Użyte zostaną testy Peto-Peto, log-rank, modyfikacja Andersena testu Peto-Peto oraz test Fleminga-Harringtona dla różnych wag. Mamy tutaj na uwadze, że tylko jedna krzywa nie przecinała się między wariantami - krzywa dla zmiennej `trt`. Dla zmiennych `laser` oraz `eye` użyte zostaną wartości z testów Renyi a dla zmiennych `risk` i `ageCat` testy trendów, gdyż są to zmienne na skali porządkowej.

```{r}
test=survdiff(Surv(time, status) ~ trt, data=diabetic, rho=1)
print("Wyniki testu Peto-Peto")
test

test=survdiff(Surv(time, status) ~ trt, data=diabetic, rho=0)
print("Wyniki testu log-rank")
test 

t = ten(mod.km.trt)
comp(t,p=c(0,1,1,0.5,0.5),q=c(1,0,1,0.5,2))
a = attr(t, "lrt")

print("Wyniki pozostałych testów")
cbind(a$W, a$pNorm)
```

Interpretacja...

```{r}
test=survdiff(Surv(time, status) ~ ageCat, data=diabetic, rho=1)
print("Wyniki testu Peto-Peto")
test 

test=survdiff(Surv(time, status) ~ ageCat, data=diabetic, rho=0)
print("Wyniki testu log-rank")
test 

t = ten(mod.km.ageCat)
comp(t,p=c(0,1,1,0.5,0.5),q=c(1,0,1,0.5,2))
a=attr(t, 'tft')

print("Wyniki pozostałych testów")
cbind(a$W, a$tft$pNorm)

```

Interpretacja...

```{r}
test=survdiff(Surv(time, status) ~ eye, data=diabetic, rho=1)
print("Wyniki testu Peto-Peto")
test

test=survdiff(Surv(time, status) ~ eye, data=diabetic, rho=0)
print("Wyniki testu log-rank")
test  

t = ten(mod.km.eye)
comp(t,p=c(0,1,1,0.5,0.5),q=c(1,0,1,0.5,2))
a = attr(t, "sup")

print("Wyniki pozostałych testów")
cbind(a$W, a$pSupBr)

```

Interpretacja...

```{r}
test=survdiff(Surv(time, status) ~ laser, data=diabetic, rho=1)
print("Wyniki testu Peto-Peto")
test

test=survdiff(Surv(time, status) ~ laser, data=diabetic, rho=0)
print("Wyniki testu log-rank")
test  

t = ten(mod.km.laser)
comp(t,p=c(0,1,1,0.5,0.5),q=c(1,0,1,0.5,2))
a = attr(t, "sup")

print("Wyniki pozostałych testów")
cbind(a$W, a$pSupBr)
```

Interpretacja...

```{r}
test=survdiff(Surv(time, status) ~ risk, data=diabetic, rho=1)
print("Wyniki testu Peto-Peto")
test

test=survdiff(Surv(time, status) ~ risk, data=diabetic, rho=0)
print("Wyniki testu log-rank")
test  

t = ten(mod.km.risk)
comp(t,p=c(0,1,1,0.5,0.5),q=c(1,0,1,0.5,2))
a = attr(t, "tft")

print("Wyniki pozostałych testów")
cbind(a$tft$W, a$tft$pNorm)
```

Interpretacja...

Podsumowanie...

```{r}
Cox=coxph(Surv(time, status)~laser+age+eye+trt+risk, data=diabetic)
summary(Cox)
library(MASS)
stepAIC(Cox,direction="backward")

Cox=coxph(Surv(time, status)~eye + trt + risk, data=diabetic)
summary(Cox)

rsq(Cox)

Prop=cox.zph(Cox,transform="identity") # weryfikacja za?o?enia proporcjonalno?ci
print(Prop)
plot(Prop)

#H0 - hazard jest proporcjonalny dla danej zmiennej w czasie

Prop=cox.zph(Cox,transform="rank") # weryfikacja za?o?enia proporcjonalno?ci
print(Prop)

Prop=cox.zph(Cox,transform="km") # weryfikacja za?o?enia proporcjonalno?ci
print(Prop)

reszty=resid(Cox, type="scaledsch") # graficzna weryfikacja za?o?enia proporcjonalno?ci
Time=as.numeric(rownames(reszty))
zmienne=c('eye','trt','risk')
for (i in 1:3) 
{plot(log(Time), reszty[,i], xlab="ln(Czas)",main=zmienne[i],
      ylab="Skalowane reszty Schoenfelda",pch=20, cex=0.7)
  lines( smooth.spline(log(Time), reszty[,i] ), lwd=3 )
}
```



```{r}
deviance=residuals(Cox,type="deviance")# jednostki odstaj?ce
s=Cox$linear.predictors
plot(s,deviance,xlab="Liniowy predyktor",ylab="Reszty odchyle?",cex=0.5, pch=20)
abline(h=3,lty=3)
diabetic$deviance=deviance
c1=which(diabetic$deviance>3)
```



```{r}
dfb=residuals(Cox,type="dfbeta")
n=dim(dfb)[1]
obs.nr=c(1:n)
for (j in 1:3) {
  plot(obs.nr,dfb[,j],xlab="Numer jednostki",ylab="Przyrost oceny parametru",
      main=zmienne[j])
  }
a1=which(dfb[,1]>(0.004)) #usun?? te jednostki
a2=which(abs(dfb[,2])>(0.06))
a3=which(abs(dfb[,3])>(0.1))
```

```{r}
c=sort(unique(c(a1,a2,a3,c1)))
dane1=diabetic[-c,] #zredukowany zbi?r
Cox2<-coxph(Surv(time, status)~eye + trt + risk, data=dane1)
stepAIC(Cox2,direction="backward")
```

