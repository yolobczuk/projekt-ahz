---
title: "R Notebook"
output: html_notebook
---



```{r include = F}
library(survival)
library(survMisc)
library(gtools)
library(ggplot2)
library(dplyr)
library(tidyr)
```

## Wprowadzenie, eksploracyjna analiza danych



Badany w niniejszym opracowaniu zbiór danych składa się z danych leczniczysz odnoszących się do wyników koagulacji laswerowej w leczeniu ratinopatii cukrzycowej. Samo schorzenie spowodowane jest uszkodzeniem naczyń krwionośnych siatkówki oka. W celu wyleczenia schorzenia używana jest laseroteriapa siatkówki. W niniejszej pracy analizowana przez nas będzie czas przeżycia w kontekście utraty ostrości wzrosku oraz wpływu danych zmiennych na przedłużanie tego procesu. W pliku zajdziemy następujące inforamcje:
  - **id**: Odnosi się do indywidualnego numeru badanej jednostki. W grupie badawczej jest 197 indywidualnych jednostek.
  - **laser**: typ zastosowanego rozwiązania laserowego w leczeniu. W próbie znajdują się dwie zmienne. Xenon oraz argon.
  - **age**: Wiek pacjenta w chwili wykrycia schorzenia.
  - **eye**: Badane oko. Zmienne to "left" oraz "right"
  - **trt**: Zmienna dychtomiczna odnosząca się do leczenia. 0 = brak leczenia, 1 =  leczenie laserowe.
  - **risk**: Grupy ryzyka w skali 6-12.
  - **time**: Czas w miesiącach do wystąpienia zdarzenia utraty wzroku, bądź ostatnia zaobserwowana obserwacja.
  - **status**: Status badanego w postaci dychotomicznej. 0 = ocenzurowane, 1 = utrata wzrosku przez badaną jednostkę.


```{r}
diabetic <- survival::diabetic


summary(diabetic)
```

Powyżej widoczne jest wstępne podsumowanie zmiennych zawartych w rozpatrywanym przez nas zbiorze danych. Widać, że w zbiorze danych nie występują wartości NA oznaczające brak danych. R zinterpretował zmienne `trt` oraz `risk` jako zmienne numeryczne, gdy one tak naprawdę są zmiennymi typu factor. Poniższy kod zamienia typy tych zmiennych na prawidłowe.

```{r}

diabetic <- diabetic %>% mutate(trt = as.factor(as.character(trt)), risk = as.factor(risk))


```
Sprawdzenie braków danych w zbiorze.

```{r}
sapply(diabetic, function(x) sum(is.na(x)))
```

Widać, że nie występują braki w naszych danych. Spojrzymy teraz również na rozkłady tych zmiennych, już po kategoryzacji.

```{r}

diabetic.plot.hist = diabetic %>% dplyr::select(c(age, time))

plot1 <- ggplot(gather(diabetic.plot.hist), aes(x = value)) +  
  geom_histogram(colour = 1, fill = "blue", bins = 30)+
  ggtitle("Rozkłady zmiennych zbioru danych")+
  ylab("Częstość występowania")+
  xlab("Wartość zmiennej")+
  facet_wrap(~ key, scales = "free", ncol = 2)
plot1

diabetic.plot.bar = diabetic %>% dplyr::select(c(laser, eye, trt, status))

plot2 <- ggplot(gather(diabetic.plot.bar), aes(x = value)) +  
  geom_bar(colour = 1, fill = "blue")+
  ggtitle("Rozkłady zmiennych zbioru danych")+
  ylab("Częstość występowania")+
  xlab("Wartość zmiennej")+
  facet_wrap(~ key, scales = "free", ncol = 2)
plot2

ggplot(as.data.frame(table(diabetic$risk)), aes(x=Var1, y = Freq)) + geom_col(colour = 1, fill = "blue")+
    ylab("Częstość występowania")+
    xlab("Wartość zmiennej risk")

rm(diabetic.plot.bar)
rm(diabetic.plot.hist)
```

Na powyższych wykresach dokonaliśmy wizualizacji badanych zmiennych. W przypadku pierwszego z nich zauważyć może częstotliwość występowowania zmiennej **age** oraz **time**. Zauważyć możemy, iż duża ilość pacjentów diagnozowana jest w stosunkowo młodym wieku, gdyż pomiędzy około 9 a 20 rokiem życia. Najmniej diagnozuje się to w wieku powyżej 55 roku życia badanej jednostki. Jednocześnie obok widoczny jest wykres częstotliowści czasu do utraty wzroku. Najczęściej występują zmienne time w okolicy pierwszych 10 miesięcy oraz od 40 do 50 miesięcy.
Kolejne wykresy przedstawiają rozkłąd dla zmiennych **eye**, **laser**, **status** oraz **trt**. W przypadku zmiennej eye mamy równą ilość badanych zmiennych. Ale możemy zwrócić na znaczną przewagę użycia xenonu, zamiast argonu w zmiennych laser. Dodatkowo widzimy, iż w zmiennej status przeważa liczba danych cenzurowanych (239) niż utraty wzroku (155). Ostania prezentowana na wykresie zmienna to trt. W tym przypadku mamy równą liczbę zmiennych.
Ostatni analizowany powyżej wykres prezentuje rozkład częstości występowania zmiennej **risk**. Widać, że najczęściej przypisywana jest wartość 9 oraz 10. Najmniej jest niskiego ryzyka na poziomie 6 oraz 8. 

## Wstępna analiza utraty wzroku

Analizę rozpoczniemy od estymacji krzywej prawdopodobieństwa zachowania wzroku w stosunku do czasu dla estymatorów Kaplana-Meiera oraz Nelsona-Aalena. Przerywanymi liniami zaznaczony został 95\% przedział ufności tych estymatorów. 

```{r}
mod.1 <- survfit(Surv(time, status) ~ 1, conf.type="plain", data=diabetic)
mod.2 <- survfit(Surv(time, status) ~ 1, conf.type="plain", type="fleming-harrington", data=diabetic)

plot(mod.1, xlab="Czas", ylab="Prawdopodobieństwo zachowania wzroku", col = 'black', pch=16)
lines(mod.2, col="red", pch=16)
legend(x = 'bottom', legend = c('Kaplan-Meier','Nelson-Aalen'), col = c('black','red'), pch=16)
```

Na powyższym wykresie nie zauważyliśmy dużych różnic pomiędzy estymatorami. Bardzo szybko (po około 2 miesiącach) prawdopodobieństwo zachowania wzroku spada poniżej 1 i utrzymuje ten spadek aż do poziomu około 60\% na którym to utrzymuje się od 60 miesięcy aż do 75 miesięcy. Spojrzymy teraz na wykresy skumulowanego hazardu.

```{r}
plot(mod.1, fun="cumhaz", xlab="Czas", ylab="Hazard skumulowany", col = 'black')
lines(mod.2, fun="cumhaz", col="red")
legend(x = 'bottom', legend = c('Kaplan-Meier','Nelson-Aalen'), col = c('black','red'), pch=16)

rm(mod.1)
rm(mod.2)
```

Oferują nam one bardzo podobną interpretację jak wykresy prawdopodobieństw. Szansa na utratę wzroku bardzo szybko (znów po około 2 miesiącach) było większe od 0 i w dość równomierny sposób wzrastała do poziomu około 0.6, na którym to utrzymywała się od około 60 miesięcy do końca osi X czyli 75 miesięcy. Przejdziemy teraz do wyznaczenia krzywych dla predyktorów zawartych w naszym zbiorze danych - zmiennych `trt`, `age`, `laser`, `eye` oraz `risk`.

```{r}
mod.km.trt <- survfit(Surv(time, status) ~ trt, conf.type="plain", data=diabetic)
mod.na.trt <- survfit(Surv(time, status) ~ trt, conf.type="plain", data=diabetic, type="fleming-harrington")

plot(mod.km.trt, xlab="Czas", ylab="Prawdopodobieństwo zachowania wzroku", col = 'black', main="Krzywa zachowania wzroku dla zmiennej trt")
lines(mod.na.trt, col="red")
legend(x = 'bottom', legend = c('Kaplan-Meier','Nelson-Aalen'), col = c('black','red'), pch=16)

mod.km.age <- survfit(Surv(time, status) ~ age, conf.type="plain", data=diabetic)
mod.na.age <- survfit(Surv(time, status) ~ age, conf.type="plain", data=diabetic, type="fleming-harrington")

plot(mod.km.age, xlab="Czas", ylab="Prawdopodobieństwo zachowania wzroku", col = 'black', main="Krzywa zachowania wzroku dla zmiennej age")
lines(mod.na.age, col="red")
legend(x = 'bottom', legend = c('Kaplan-Meier','Nelson-Aalen'), col = c('black','red'), pch=16)

mod.km.laser <- survfit(Surv(time, status) ~ laser, conf.type="plain", data=diabetic)
mod.na.laser <- survfit(Surv(time, status) ~ laser, conf.type="plain", data=diabetic, type="fleming-harrington")

plot(mod.km.laser, xlab="Czas", ylab="Prawdopodobieństwo zachowania wzroku", col = 'black', main="Krzywa zachowania wzroku dla zmiennej laser")
lines(mod.na.laser, col="red")
legend(x = 'bottom', legend = c('Kaplan-Meier','Nelson-Aalen'), col = c('black','red'), pch=16)

mod.km.eye <- survfit(Surv(time, status) ~ eye, conf.type="plain", data=diabetic)
mod.na.eye <- survfit(Surv(time, status) ~ eye, conf.type="plain", data=diabetic, type="fleming-harrington")

plot(mod.km.eye, xlab="Czas", ylab="Prawdopodobieństwo zachowania wzroku", col = 'black', main="Krzywa zachowania wzroku dla zmiennej eye")
lines(mod.na.eye, col="red")
legend(x = 'bottom', legend = c('Kaplan-Meier','Nelson-Aalen'), col = c('black','red'), pch=16)

mod.km.risk <- survfit(Surv(time, status) ~ risk, conf.type="plain", data=diabetic)
mod.na.risk <- survfit(Surv(time, status) ~ risk, conf.type="plain", data=diabetic, type="fleming-harrington")

plot(mod.km.risk, xlab="Czas", ylab="Prawdopodobieństwo zachowania wzroku", col = 'black', main="Krzywa zachowania wzroku dla zmiennej risk")
lines(mod.na.risk, col="red")
legend(x = 'bottom', legend = c('Kaplan-Meier','Nelson-Aalen'), col = c('black','red'), pch=16)


```

**Krzywa zachowania wzroku zmiennej trt**
Powyżej przedstawione zostały wykresy prawdopodbieństwa zachowania wzroku z wykorzystaniem estymatora Kaplana-Meiera oraz Nelona-Aalena. Widzimy w przypadku krzywej zachowania wzroku dla zmiennej **trt**, że prawdopodobeństwo zachowania wzroku stopniowo maleje. W przypadku estymatora Nelsona-Aalena jednostka ma 80% na utrzymanie wzroku dłużej niż przez 11 miesięcy. Estymator Kaplana-Meiera wskazuje, że jest 80% szans na utrzymanie wzroku dłużej niż 25 miesięcy. Jest bardzo duża różnica na 60 miesiącach, gdzie estymator Nelsona-Aalena wskazuje na 40% szans utrzymania wzroku dłużej niż 60 miesięcy od diagnozy, a estymator Kaplana-Meiera wskazuje 70% szans na utrzymanie wzroku dłużej niż 60 miesięcy.


**Krzywa zachowania wzroku zmiennej age**
Ze względu na dość chaotyczny wygląd wykresu dla zmiennej age, zdecydowaliśmy się na faktoryzację tej zmiennej poprzez podział kwantylowy. Poniżej znajdują się wykresy z estymatorami K-M oraz N-A dla tej zmiennej.


```{r}
diabetic$ageCat <- quantcut(diabetic$age,q=4)

mod.km.ageCat <- survfit(Surv(time, status) ~ ageCat, conf.type="plain", data=diabetic)
mod.na.ageCat <- survfit(Surv(time, status) ~ ageCat, conf.type="plain", data=diabetic, type="fleming-harrington")

plot(mod.km.ageCat, xlab="Czas", ylab="Prawdopodobieństwo zachowania wzroku", col = 'black', main="Krzywa zachowania wzroku dla zmiennej ageCat (po faktoryzacji)")
lines(mod.na.ageCat, col="red")
legend(x = 'bottom', legend = c('Kaplan-Meier','Nelson-Aalen'), col = c('black','red'), pch=16)
```

Interpretacja...

Po wizualnej inspekcji przyszedł czas na formalne testy. Użyte zostaną testy Peto-Peto, log-rank, modyfikacja Andersena testu Peto-Peto oraz test Fleminga-Harringtona dla różnych wag. Mamy tutaj na uwadze, że tylko jedna krzywa nie przecinała się między wariantami - krzywa dla zmiennej `trt`. Dla zmiennych `laser` oraz `eye` użyte zostaną wartości z testów Renyi a dla zmiennych `risk` i `ageCat` testy trendów, gdyż są to zmienne na skali porządkowej.

```{r}
km_by_trt <- survfit(Surv(time, status) ~ trt, conf.type="plain", data=diabetic)
plot(km_by_trt, col=c("blue", "red"),xlab="Czas",ylab="Prawdopodobieństwo przeżycia")
legend(10,0.3,c("no treatment", "laser"),lty=1, col=c("blue", "red"),bty="n")

test=survdiff(Surv(time, status) ~ trt, data=diabetic, rho=1)
print("Wyniki testu Peto-Peto")
test

test=survdiff(Surv(time, status) ~ trt, data=diabetic, rho=0)
print("Wyniki testu log-rank")
test 

t = ten(mod.km.trt)
comp(t,p=c(0,1,1,0.5,0.5),q=c(1,0,1,0.5,2))
a = attr(t, "lrt")

print("Wyniki pozostałych testów")
cbind(a$W, a$pNorm)
```

Powyżej przedstawiony został wpływ zmiennej **trt** na wyniki prawdopobieństwa utarty wzroku przez badaną jednostkę. Jak możemy zauważyć linie zachowują inaczej. Badana jednostka ma 80% szans na utrzymanie wzroku dłużej niż 15 miesięcy bez leczenia. W przypadku leczenia laserowego badana jednostka ma 80% szans na utrzymanie wzroku dłużej niż 20 miesięcy. Po wynikach testu możemy również zauważyć różnicę rozkładów. Test Log Rank wskazuje na poziomie istotności 0,05 na odrzucenie hipotezy zerowej na rzecz alternatywnej mówiącej o różnicy rozkładów, co oznacza, że jest znaczna różnica pomiędzy wynikami braku zabiegów a przyjmowaniem zabiegu laserowego.

```{r}


test=survdiff(Surv(time, status) ~ ageCat, data=diabetic, rho=1)
print("Wyniki testu Peto-Peto")
test 

test=survdiff(Surv(time, status) ~ ageCat, data=diabetic, rho=0)
print("Wyniki testu log-rank")
test 

t = ten(mod.km.ageCat)
comp(t,p=c(0,1,1,0.5,0.5),q=c(1,0,1,0.5,2))
a=attr(t, 'tft')

print("Wyniki pozostałych testów")
cbind(a$W, a$tft$pNorm)

```

Interpretacja...

```{r}

km_by_eye <- survfit(Surv(time, status) ~ eye, conf.type="plain", data=diabetic)
plot(km_by_eye, col=c("blue", "red"),xlab="Czas",ylab="Prawdopodobieństwo przeżycia")
legend(10,0.3,c("left", "right"),lty=1, col=c("blue", "red"),bty="n")


test=survdiff(Surv(time, status) ~ eye, data=diabetic, rho=1)
print("Wyniki testu Peto-Peto")
test

test=survdiff(Surv(time, status) ~ eye, data=diabetic, rho=0)
print("Wyniki testu log-rank")
test  

t = ten(mod.km.eye)
comp(t,p=c(0,1,1,0.5,0.5),q=c(1,0,1,0.5,2))
a = attr(t, "sup")

print("Wyniki pozostałych testów")
cbind(a$W, a$pSupBr)

```

Na powyżej przedstawionym wykresie prawdopodobieństwa utraty wzroku z podziałem na wpływ zmiennych **eye**. Widać, iż przeprowadzone testy wskazały na poziomie istotności 0,05 na odrzucenie hipotezy zerowej i przyjęcie hipotezy alternatywnej, mówiącej o różnicy między wynikami badanych zmiennych. Na wykresie widać, iż do około 80% szans zmienne zachowują się tak samo. Czy to prawe, czy lewe oko to w obu przypadkach występuje około 80% szans na utrzymanie wzroku dłużej niż 20 miesięcy. Po 20 miesiącach zwiększa się prawdopodobieństwo dla lewego oka. Na utrzymanie wzroku dłużej niż 60 miesięcy prawdopodobieństwo dla lewego oka jest nawet o 10% wyższe.

```{r}
km_by_laser <- survfit(Surv(time, status) ~ laser, conf.type="plain", data=diabetic)
plot(km_by_laser, col=c("blue", "red"),xlab="Czas",ylab="Prawdopodobieństwo przeżycia")
legend(10,0.3,c("xenon", "argon"),lty=1, col=c("blue", "red"),bty="n")

test=survdiff(Surv(time, status) ~ laser, data=diabetic, rho=1)
print("Wyniki testu Peto-Peto")
test

test=survdiff(Surv(time, status) ~ laser, data=diabetic, rho=0)
print("Wyniki testu log-rank")
test  

t = ten(mod.km.laser)
comp(t,p=c(0,1,1,0.5,0.5),q=c(1,0,1,0.5,2))
a = attr(t, "sup")

print("Wyniki pozostałych testów")
cbind(a$W, a$pSupBr)
```

Powyżej przedstawione zostało sprawdzenie prawdopodobieństwa utraty wzroku w przypadku użycia różnej formy terapi laserowej. Po wynikach testów oraz wizualizacji widzimy, iż grupy zachowują się bardzo podobnie. W teście log rank na poziomie istoności 0,05 nie mamy podstaw do odrzucenia hipotezy zerowej mówiącej o podobieństwie rozkładu grup dla utraty wzroku. Badana jednostka ma w przypadku obu zastosowanych metod 80% szans na utrzymanie wzroku dłużej niż 18 miesięcy. Różnica pojawia się na końcu, gdzie osoby leczone xenonem mają około 6% większą szansę utrzymania wzroku dłużej niż 60 miesięcy.

```{r}

km_by_risk <- survfit(Surv(time, status) ~ risk, conf.type="plain", data=diabetic)
plot(km_by_risk, col=c("blue", "red", "green"
, "yellow","grey", 'black'),xlab="Czas",ylab="Prawdopodobieństwo przeżycia")
legend(10,0.3,c("6", "8", "9", "10", "11", "12"),lty=1, col=c("blue", "red", "green"
, "yellow","grey", 'black'),bty="n")


test=survdiff(Surv(time, status) ~ risk, data=diabetic, rho=1)
print("Wyniki testu Peto-Peto")
test

test=survdiff(Surv(time, status) ~ risk, data=diabetic, rho=0)
print("Wyniki testu log-rank")
test  

t = ten(mod.km.risk)
comp(t,p=c(0,1,1,0.5,0.5),q=c(1,0,1,0.5,2))
a = attr(t, "tft")

print("Wyniki pozostałych testów")
cbind(a$tft$W, a$tft$pNorm)
```

Do sprawdzenia, czy dobrze tu są brane zmienne na wykres.

Na podstawie wyników testów możemy stwierdzić, iż na poziomie istoności 0,05 odrzucamy hipotezę zerową mówiącą o podobieństwie grup na rzecz alternatywnej. Badane przez nas grupy mają rożne rozkłady przeżycia. Zauważyć możemy, iż nakrótszy okres przeżycia będzie w grupie 10. Najdłużysz będzie w najniższej grupie 6.



Podsumowanie...

```{r}
Cox=coxph(Surv(time, status)~laser+age+eye+trt+risk, data=diabetic)
summary(Cox)
library(MASS)
stepAIC(Cox,direction="backward")
```
#Do weryfikacji

Po wynikach modelu proporcjonalnego hazardu Coxa widzimy, że istone zmienne do naszego modelu na poziomie istotności 0,05 to grupa 10 ryzyka oraz przeprowadzanie badania **trt**. 

#Do opisania parametry modelu. 

Ucięty AICem Cox

```{r}
Cox=coxph(Surv(time, status)~eye + trt + risk, data=diabetic)
summary(Cox)
```

Miary R-kwadrat dla Coxa

```{r}
rsq(Cox)
```

Weryfikacja założenia o proporcjonalności, H0 - hazard jest proporcjonalny dla danej zmiennej w czasie, na wykresach linia chyba musi być w miarę prosta (wykres liniowy albo stały)

```{r}
Prop=cox.zph(Cox,transform="identity")
print(Prop)
plot(Prop)

Prop=cox.zph(Cox,transform="rank")
print(Prop)

Prop=cox.zph(Cox,transform="km")
print(Prop)

reszty=resid(Cox, type="scaledsch")
Time=as.numeric(rownames(reszty))
zmienne=c('eye','trt','risk')
for (i in 1:3) 
{plot(log(Time), reszty[,i], xlab="ln(Czas)",main=zmienne[i],
      ylab="Skalowane reszty Schoenfelda",pch=20, cex=0.7)
  lines( smooth.spline(log(Time), reszty[,i] ), lwd=3 )
}
```

Wyrzucenie obserwacji o dużej dewiancji (dewiancja wyższa niż 3 odchylenia standardowe)

```{r}
deviance <- residuals(Cox,type="deviance")
lin.pred <- Cox$linear.predictors
plot(lin.pred, deviance, xlab="Liniowy predyktor", ylab="Reszty odchyleń", cex=0.5, pch=20)
abline(h=3,lty=3)
diabetic$deviance <- deviance
to.del.1 <- which(diabetic$deviance>3)
```

Wyrzucenie obserwacji na podstawie dfbeta (nwm co to)

```{r}
df.beta <- residuals(Cox,type="dfbeta")
n <- dim(df.beta)[1]
obs.nr <- c(1:n)
for (j in 1:3) {
  plot(obs.nr, df.beta[,j], xlab="Numer jednostki", ylab="Przyrost oceny parametru", main=zmienne[j])
}
to.del.2 <- which(df.beta[,1] < (-0.01))
to.del.3 <- which(abs(df.beta[,2])>(0.01))
```

Ostateczny model

```{r}
c <- sort(unique(c(to.del.1, to.del.2, to.del.3)))
diabetic.red <- diabetic[-c,] 
Cox2 <- coxph(Surv(time, status)~eye + trt + risk, data=diabetic.red)
stepAIC(Cox2,direction="backward")
```

